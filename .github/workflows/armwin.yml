name: Windows ARM64 æ„å»º (å…¬å¼€ä»“åº“ç‰ˆæœ¬)

# è¿™ä¸ªæ–‡ä»¶åº”è¯¥æ”¾åœ¨å…¬å¼€ä»“åº“ä¸­
# å®ƒä¼šæ‹‰å–ç§æœ‰ä»“åº“çš„ä»£ç è¿›è¡Œ Windows ARM æ¶æ„æ„å»º

# ============================================
# é…ç½®ç§æœ‰ä»“åº“ä¿¡æ¯ï¼ˆåœ¨è¿™é‡Œä¿®æ”¹ï¼‰
# ============================================
env:
  PRIVATE_REPO: 'print520/NetAPP'  # ä¿®æ”¹ä¸ºä½ çš„ç§æœ‰ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)
  PRIVATE_REPO_REF: 'main'         # ä¿®æ”¹ä¸ºä½ è¦æ„å»ºçš„åˆ†æ”¯/æ ‡ç­¾/commit

on:
  workflow_dispatch:
    inputs:
      config_urls:
        description: 'é…ç½®URLåˆ—è¡¨ï¼ˆä»¥é€—å·åˆ†éš”ï¼‰'
        required: true
        default: ''
      update_url:
        description: 'æ›´æ–°æ£€æŸ¥URL'
        required: true
        default: ''
      app_id:
        description: 'åº”ç”¨ID(ä»…é™è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿)'
        required: true
        default: ''
      display_name:
        description: 'æ˜¾ç¤ºåç§°(æ”¯æŒä¸­æ–‡)'
        required: true
        default: ''
      icon_url:
        description: 'åº”ç”¨å›¾æ ‡URL'
        required: true
        default: ''
      identifier:
        description: 'åº”ç”¨idè¯†åˆ«ç '
        required: true
        default: ''
      version:
        description: 'ç‰ˆæœ¬å·'
        required: true
        default: '2.0.1'
      test_url:
        description: 'æµ‹é€ŸURL'
        required: true
        default: 'http://cp.cloudflare.com/generate_204'

jobs:
  build-windows-arm64:
    # ä½¿ç”¨ Windows ARM æ¶æ„çš„ runner
    runs-on: windows-11-arm
    
    steps:
      # ============================================
      # æ­¥éª¤ 1: æ£€å‡ºç§æœ‰ä»“åº“ä»£ç 
      # ============================================
      - name: æ£€å‡ºç§æœ‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PRIVATE_REPO }}
          ref: ${{ env.PRIVATE_REPO_REF }}
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          submodules: recursive
      
      # ============================================
      # æ­¥éª¤ 2: è®¾ç½® Rust ç¯å¢ƒ (Windows ARM éœ€è¦)
      # ============================================
      - name: è®¾ç½® Rust ç¯å¢ƒ
        run: |
          Invoke-WebRequest -Uri "https://win.rustup.rs/aarch64" -OutFile rustup-init.exe
          .\rustup-init.exe -y --default-toolchain stable
          $cargoPath = "$env:USERPROFILE\.cargo\bin"
          Add-Content $env:GITHUB_PATH $cargoPath
        shell: pwsh

      # ============================================
      # æ­¥éª¤ 3: è·å–åº”ç”¨å›¾æ ‡
      # ============================================
      - name: è·å–åº”ç”¨å›¾æ ‡
        run: |
          mkdir -p temp_icons
          curl -L ${{ github.event.inputs.icon_url }} -o temp_icons/app_icon.png
        shell: bash

      # ============================================
      # æ­¥éª¤ 4: ä¿®æ”¹é…ç½®URLs
      # ============================================
      - name: ä¿®æ”¹é…ç½®URLs
        run: |
          $configFile = "lib/common/config_service.dart"
          $configUrls = "${{ github.event.inputs.config_urls }}" -split ","
          
          # è¯»å–åŸå§‹æ–‡ä»¶å†…å®¹
          $content = Get-Content $configFile -Raw
          
          # æ„å»ºæ–°çš„URLsæ•°ç»„å­—ç¬¦ä¸²
          $newUrls = "["
          for ($i = 0; $i -lt $configUrls.Count; $i++) {
            $url = $configUrls[$i].Trim()
            $newUrls += "`n    '$url'"
            if ($i -lt ($configUrls.Count - 1)) {
              $newUrls += ","
            }
          }
          $newUrls += "`n  ]"
          
          # ä½¿ç”¨ç²¾ç¡®åŒ¹é…æ¨¡å¼æ›¿æ¢
          $pattern = "static const List<String> _configUrls = \[[^\]]*\];"
          $replacement = "static const List<String> _configUrls = $newUrls;"
          
          # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢
          $content = [regex]::Replace($content, $pattern, $replacement)
          
          # å†™å›æ–‡ä»¶
          $content | Set-Content $configFile -Force -Encoding UTF8
          
          # ç¡®è®¤ä¿®æ”¹
          Write-Host "å·²ä¿®æ”¹é…ç½®URLs:"
          Get-Content $configFile | Select-String -Context 0,5 "_configUrls"
        shell: pwsh

      # ============================================
      # æ­¥éª¤ 5: ä¿®æ”¹æ›´æ–°URL
      # ============================================
      - name: ä¿®æ”¹æ›´æ–°URL
        run: |
          $apiFile = "lib/common/api_service.dart"
          $updateUrl = "${{ github.event.inputs.update_url }}"
          
          # æ›¿æ¢æ›´æ–°URL
          if (Test-Path $apiFile) {
            (Get-Content $apiFile) -replace "final customUpdateUrl = `"[^`"]+`";", "final customUpdateUrl = `"$updateUrl`";" | Set-Content $apiFile
            Write-Host "å·²ä¿®æ”¹æ›´æ–°URL:"
            Get-Content $apiFile | Select-String "customUpdateUrl"
          } else {
            Write-Host "è­¦å‘Š: APIæ–‡ä»¶ $apiFile ä¸å­˜åœ¨ï¼Œè·³è¿‡æ›´æ–°URLä¿®æ”¹"
          }
        shell: pwsh

      # ============================================
      # æ­¥éª¤ 6: æ›¿æ¢æµ‹é€ŸURL
      # ============================================
      - name: æ›¿æ¢æµ‹é€ŸURL defaultTestUrl
        run: |
          $testUrl = "${{ github.event.inputs.test_url }}"
          $file = "lib/common/constant.dart"
          if (Test-Path $file) {
            (Get-Content $file -Raw) -replace "const defaultTestUrl = '[^']*';", "const defaultTestUrl = '$testUrl';" | Set-Content $file -Encoding UTF8
            Get-Content $file | Select-String 'defaultTestUrl'
          } else {
            Write-Host "æœªæ‰¾åˆ° $file"
          }
        shell: pwsh

      # ============================================
      # æ­¥éª¤ 7: ä¿®æ”¹ distribute_options.yaml ä¸­çš„åº”ç”¨åç§°
      # ============================================
      - name: ä¿®æ”¹ distribute_options.yaml ä¸­çš„åº”ç”¨åç§°
        run: |
          $displayName = "${{ github.event.inputs.display_name }}"
          $distributeFile = "distribute_options.yaml"
          
          if (Test-Path $distributeFile) {
            # è¯»å–æ–‡ä»¶å†…å®¹
            $content = Get-Content $distributeFile -Raw
            
            # ä¿®æ”¹ app_name å±æ€§
            $content = $content -replace "app_name: 'FlClash'", "app_name: '$displayName'"
            $content = $content -replace "app_name: `"FlClash`"", "app_name: `"$displayName`""
            
            # å†™å›æ–‡ä»¶
            $content | Set-Content $distributeFile -Force
            
            Write-Host "å·²ä¿®æ”¹ distribute_options.yaml ä¸­çš„åº”ç”¨åç§°ä¸º: $displayName"
          } else {
            Write-Host "è­¦å‘Š: æ‰¾ä¸åˆ° distribute_options.yaml æ–‡ä»¶"
          }
        shell: pwsh

      # ============================================
      # æ­¥éª¤ 8: ä¿®æ”¹æ˜¾ç¤ºåç§°å’Œç‰ˆæœ¬
      # ============================================
      - name: ä¿®æ”¹æ˜¾ç¤ºåç§°å’Œç‰ˆæœ¬
        run: |
          # ä½¿ç”¨è¾“å…¥çš„æ˜¾ç¤ºåç§°
          $displayName = "${{ github.event.inputs.display_name }}"
          $app_id = "${{ github.event.inputs.app_id }}"
          $identifier = "${{ github.event.inputs.identifier }}"
          
          # ä¿®æ”¹Windowsé…ç½®ä¸­çš„æ˜¾ç¤ºåç§° - ä»…ä¿®æ”¹display_name
          if (Test-Path "windows/packaging/exe/make_config.yaml") {
            # è¯»å–æ–‡ä»¶å†…å®¹
            $content = Get-Content 'windows/packaging/exe/make_config.yaml' -Raw
            
            # ä¿®æ”¹åº”ç”¨å†…éƒ¨åç§° æ˜¾ç¤ºåç§° å”¯ä¸€è¯†åˆ«id
            $content = $content -replace "display_name: .*", "display_name: $displayName"
            $content = $content -replace "app_name: .*", "app_name: $app_id"
            $content = $content -replace "executable_name: .*", "executable_name: ${app_id}.exe"
            $content = $content -replace "output_base_file_name: .*", "output_base_file_name: ${displayName}.exe"
            $content = $content -replace "app_id: .*", "app_id: $identifier"
            
            # æ·»åŠ æˆ–ä¿®æ”¹å®‰è£…ç›®å½•åç§°ï¼Œä½¿ç”¨è‹±æ–‡app_idé¿å…ä¸­æ–‡ç›®å½•å
            if ($content -match "install_dir_name:") {
              $content = $content -replace "install_dir_name: .*", "install_dir_name: `"{autopf64}\\$app_id`""
            } else {
              $content += "`ninstall_dir_name: `"{autopf64}\\$app_id`""
            }
            
            # å†™å›æ–‡ä»¶
            $content | Set-Content 'windows/packaging/exe/make_config.yaml' -Force
            
            Write-Host "å·²æ›´æ–°Windowsåº”ç”¨æ˜¾ç¤ºåç§°é…ç½®:"
            Get-Content 'windows/packaging/exe/make_config.yaml'
          }
          
          $cmake_file = "windows/CMakeLists.txt"
          
          # ç²¾ç¡®æ›¿æ¢FlClashä¸ºä¼ å…¥çš„app_id
          (Get-Content $cmake_file) -replace 'set\(BINARY_NAME "FlClash"\)', "set(BINARY_NAME `"$app_id`")" | Set-Content $cmake_file
          
          # æ›¿æ¢æ ¸å¿ƒæ–‡ä»¶çš„å®‰è£…è·¯å¾„
          $content = Get-Content $cmake_file -Raw
          $content = $content -replace 'FlClashCore\.exe', "${app_id}Core.exe"
          $content = $content -replace 'FlClashHelperService\.exe', "${app_id}HelperService.exe"
          $content | Set-Content $cmake_file -Force
          
          Write-Host "å·²ä¿®æ”¹ CMakeLists.txt ä¸­çš„æ‰€æœ‰æ–‡ä»¶å"
        shell: pwsh

      # ============================================
      # æ­¥éª¤ 9: ä¿®æ”¹ç‰ˆæœ¬å·å’Œåº”ç”¨åç§°
      # ============================================
      - name: ä¿®æ”¹ç‰ˆæœ¬å·å’Œåº”ç”¨åç§°
        run: |
          # ä½¿ç”¨è¾“å…¥çš„æ˜¾ç¤ºåç§°
          $displayName = "${{ github.event.inputs.display_name }}"
          $app_id = "${{ github.event.inputs.app_id }}"
          $identifier = "${{ github.event.inputs.identifier }}"
          
          # ä¿®æ”¹ç‰ˆæœ¬å·
          $version = "${{ github.event.inputs.version }}"
          $buildNumber = Get-Date -Format "yyyyMMddHH"
          # åŒ¹é…å¯é€‰çš„ build number
          (Get-Content pubspec.yaml) -replace "version: [0-9]+\.[0-9]+\.[0-9]+(\+[0-9]+)?", "version: $version+$buildNumber" | Set-Content pubspec.yaml
          
          # ä¿®æ”¹ constant.dart ä¸­çš„ appNameï¼ˆç”¨äºæ³¨å†Œè¡¨é”®åå’Œè‡ªå¯åŠ¨ï¼‰
          $constantFile = "lib/common/constant.dart"
          if (Test-Path $constantFile) {
            # ä½¿ç”¨ app_id ä½œä¸ºå†…éƒ¨æ ‡è¯†ç¬¦ï¼ˆç”¨äºæ³¨å†Œè¡¨ç­‰ï¼‰ï¼Œé¿å…ä½¿ç”¨ä¸­æ–‡
            $content = Get-Content $constantFile -Raw
            # åªæ”¯æŒå•å¼•å·ï¼ˆä»£ç ä¸­ä½¿ç”¨çš„æ ¼å¼ï¼‰
            $content = $content -replace "const appName = '[^']+';", "const appName = '$app_id';"
            $content | Set-Content $constantFile -NoNewline
            Write-Host "å·²æ›´æ–° constant.dart ä¸­çš„ appName ä¸º: $app_id"
            Get-Content $constantFile | Select-String -Pattern "const appName"
          }
          
          # æŸ¥çœ‹ä¿®æ”¹åçš„æ–‡ä»¶
          Get-Content pubspec.yaml | Select-String -Pattern "version:"
        shell: pwsh

      # ============================================
      # æ­¥éª¤ 10: æ›¿æ¢å›¾æ ‡ - Windows (ä½¿ç”¨ Python Pillow)
      # ============================================
      - name: æ›¿æ¢å›¾æ ‡ - Windows
        run: |
          # å®‰è£… Pillow åº“ï¼ˆæ›´å¯é çš„å›¾åƒå¤„ç†æ–¹æ¡ˆï¼‰
          python -m pip install --upgrade pip
          pip install Pillow
          
          # åˆ›å»º Python è„šæœ¬æ¥å¤„ç†å›¾æ ‡è½¬æ¢
          @"
          import sys
          import io
          from PIL import Image
          import os
          
          # è®¾ç½® UTF-8 è¾“å‡ºï¼Œé¿å…ç¼–ç é”™è¯¯
          sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
          
          # è¯»å–æºå›¾æ ‡
          icon = Image.open('temp_icons/app_icon.png')
          
          # è½¬æ¢ä¸º RGBA æ¨¡å¼ï¼ˆå¦‚æœéœ€è¦ï¼‰
          if icon.mode != 'RGBA':
              icon = icon.convert('RGBA')
          
          # 1. è½¬æ¢ä¸º ICO æ ¼å¼ (256x256) - Windows runner å›¾æ ‡
          icon_256 = icon.resize((256, 256), Image.Resampling.LANCZOS)
          icon_256.save('windows/runner/resources/app_icon.ico', format='ICO', sizes=[(256, 256)])
          print('[OK] Generated windows/runner/resources/app_icon.ico')
          
          # 2. åˆ›å»º assets/images ç›®å½•
          os.makedirs('assets/images', exist_ok=True)
          
          # 3. ç”Ÿæˆ 550x550 PNG (assets ç›®å½•)
          icon_550 = icon.resize((550, 550), Image.Resampling.LANCZOS)
          icon_550.save('assets/images/icon.png', format='PNG')
          print('[OK] Generated assets/images/icon.png')
          
          # 4. ç”Ÿæˆ 256x256 ICO (assets ç›®å½•)
          icon_256.save('assets/images/icon.ico', format='ICO', sizes=[(256, 256)])
          print('[OK] Generated assets/images/icon.ico')
          
          print('[SUCCESS] All icons converted successfully!')
          "@ | Out-File -FilePath convert_icon.py -Encoding UTF8
          
          # æ‰§è¡Œ Python è„šæœ¬
          python convert_icon.py
          
          # æ¸…ç†ä¸´æ—¶è„šæœ¬
          Remove-Item convert_icon.py
          
          Write-Host "å·²æˆåŠŸæ›¿æ¢æ‰€æœ‰å›¾æ ‡" -ForegroundColor Green
        shell: pwsh
        
      # ============================================
      # æ­¥éª¤ 11: æ›¿æ¢æ‰€æœ‰FlClashç›¸å…³å­—ç¬¦ä¸²
      # ============================================
      - name: æ›¿æ¢æ‰€æœ‰FlClashç›¸å…³å­—ç¬¦ä¸²
        run: |
          $app_id = "${{ github.event.inputs.app_id }}"
          
          # 1. æ›¿æ¢windows.rsä¸­çš„æœåŠ¡åç§° - ä½¿ç”¨ regex::Escape æ–¹æ³•
          $windowsRsFile = "services/helper/src/service/windows.rs"
          if (Test-Path $windowsRsFile) {
            $content = Get-Content $windowsRsFile -Raw
            
            # ä½¿ç”¨ regex::Escape ç¡®ä¿ç‰¹æ®Šå­—ç¬¦è¢«æ­£ç¡®å¤„ç†
            $serviceNamePattern = 'const SERVICE_NAME: &str = "FlClashHelperService";'
            $serviceNameReplacement = "const SERVICE_NAME: &str = `"${app_id}HelperService`";"
            $content = $content -replace [regex]::Escape($serviceNamePattern), $serviceNameReplacement
            
            $content | Set-Content $windowsRsFile -Force -Encoding UTF8
            Write-Host "å·²æ›¿æ¢ windows.rs ä¸­çš„æœåŠ¡åç§°ä¸º: ${app_id}HelperService"
          }
          
          # 2. æ›¿æ¢constant.dartä¸­çš„ç›¸å…³å¸¸é‡
          $constantDartFile = "lib/common/constant.dart"
          if (Test-Path $constantDartFile) {
            $content = Get-Content $constantDartFile -Raw
            
            # æ›¿æ¢appNameå¸¸é‡ï¼ˆå•å¼•å·ï¼‰
            $content = $content -replace [regex]::Escape("const appName = 'FlClash';"), "const appName = '$app_id';"
            if ($content -match [regex]::Escape("const appHelperService = 'FlClashHelperService';")) {
              $content = $content -replace [regex]::Escape("const appHelperService = 'FlClashHelperService';"), "const appHelperService = '${app_id}HelperService';"
            }
            # å¦‚æœæœ‰é¢å¤–çš„appCoreNameç­‰å¸¸é‡ï¼Œç¡®ä¿ä¹Ÿæ›¿æ¢å®ƒä»¬
            if ($content -match [regex]::Escape("const appCoreName = 'FlClashCore';")) {
              $content = $content -replace [regex]::Escape("const appCoreName = 'FlClashCore';"), "const appCoreName = '${app_id}Core';"
            }

            if ($content -match [regex]::Escape("const appSocketPrefix = 'FlClashSocket_';")) {
              $content = $content -replace [regex]::Escape("const appSocketPrefix = 'FlClashSocket_';"), "const appSocketPrefix = '${app_id}Socket_';"
            }

            
            # æ›¿æ¢unixSocketPathä¸­çš„FlClashSocket_ - ä½¿ç”¨ regex::Escape æ–¹æ³•
            $socketPattern = "final unixSocketPath = '/tmp/FlClashSocket_`${Random().nextInt(10000)}.sock';"
            $socketReplacement = "final unixSocketPath = '/tmp/${app_id}Socket_`${Random().nextInt(10000)}.sock';"
            $content = $content -replace [regex]::Escape($socketPattern), $socketReplacement
            
            # æ›¿æ¢mainIsolateåç§° - ä½¿ç”¨ regex::Escape æ–¹æ³•
            $mainIsolatePattern = "final mainIsolate = 'FlClashMainIsolate';"
            $mainIsolateReplacement = "final mainIsolate = '${app_id}MainIsolate';"
            $content = $content -replace [regex]::Escape($mainIsolatePattern), $mainIsolateReplacement
            
            # æ›¿æ¢serviceIsolateåç§° - ä½¿ç”¨ regex::Escape æ–¹æ³•
            $serviceIsolatePattern = "final serviceIsolate = 'FlClashServiceIsolate';"
            $serviceIsolateReplacement = "final serviceIsolate = '${app_id}ServiceIsolate';"
            $content = $content -replace [regex]::Escape($serviceIsolatePattern), $serviceIsolateReplacement
            
            # å†™å›æ–‡ä»¶
            $content | Set-Content $constantDartFile -Force -Encoding UTF8
            Write-Host "å·²æ›¿æ¢ constant.dart ä¸­çš„æ‰€æœ‰ FlClash ç›¸å…³å¸¸é‡"
          }
          
          # 3. æ›¿æ¢path.dartä¸­çš„ç›¸å…³è·¯å¾„ - ä½¿ç”¨ç®€å•ç›´æ¥çš„å­—ç¬¦ä¸²æ›¿æ¢
          $pathDartFile = "lib/common/path.dart"
          if (Test-Path $pathDartFile) {
            $content = Get-Content $pathDartFile -Raw
            
            # ä½¿ç”¨ç®€å•çš„å­—ç¬¦ä¸²æ›¿æ¢ï¼Œé¿å…å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼
            $content = $content.Replace("'FlClash.lock'", "'$app_id.lock'")
            $content = $content.Replace("'FlClashCore`$executableExtension'", "'${app_id}Core`$executableExtension'")
            
            # å†™å›æ–‡ä»¶
            $content | Set-Content $pathDartFile -Force -Encoding UTF8
            Write-Host "å·²æ›¿æ¢ path.dart ä¸­çš„æ‰€æœ‰ FlClash ç›¸å…³è·¯å¾„"
            
            # éªŒè¯æ›¿æ¢ç»“æœ - æ˜¾ç¤ºå…·ä½“å†…å®¹
            Write-Host "path.dart ä¸­çš„å…³é”®è¡Œ:"
            Get-Content $pathDartFile | Select-String -Pattern "corePath|lockFilePath" -Context 1,1
            
            # é¢å¤–éªŒè¯ï¼šæ£€æŸ¥æ˜¯å¦è¿˜æœ‰ FlClash å­—ç¬¦ä¸²
            $remainingFlClash = Get-Content $pathDartFile | Select-String -Pattern "FlClash"
            if ($remainingFlClash) {
              Write-Host "è­¦å‘Š: path.dart ä¸­ä»æœ‰æœªæ›¿æ¢çš„ FlClash å­—ç¬¦ä¸²:" -ForegroundColor Red
              $remainingFlClash | ForEach-Object { Write-Host "  $_" -ForegroundColor Yellow }
            } else {
              Write-Host "âœ“ path.dart ä¸­æ‰€æœ‰ FlClash å­—ç¬¦ä¸²å·²æˆåŠŸæ›¿æ¢" -ForegroundColor Green
            }
          }
          
          
          # 4. éªŒè¯æ‰€æœ‰æ›¿æ¢æ˜¯å¦æˆåŠŸ
          Write-Host "`n========== éªŒè¯æ›¿æ¢ç»“æœ ==========" -ForegroundColor Yellow
          
          # éªŒè¯ constant.dart
          Write-Host "`n[constant.dart]" -ForegroundColor Cyan
          Get-Content "lib/common/constant.dart" | Select-String -Pattern "const appName|const appHelperService"
          
          # éªŒè¯ path.dart
          Write-Host "`n[path.dart]" -ForegroundColor Cyan
          Get-Content "lib/common/path.dart" | Select-String -Pattern "FlClash"
          
          # éªŒè¯ windows.rs
          Write-Host "`n[windows.rs]" -ForegroundColor Cyan
          Get-Content "services/helper/src/service/windows.rs" | Select-String -Pattern "SERVICE_NAME"
          
          Write-Host "`n========== éªŒè¯å®Œæˆ ==========" -ForegroundColor Yellow
          Write-Host "æ‰€æœ‰FlClashç›¸å…³å­—ç¬¦ä¸²æ›¿æ¢å®Œæˆ" -ForegroundColor Green
        shell: pwsh

      # ============================================
      # æ­¥éª¤ 12: ä¿®æ”¹ç™»å½•é¡µé¢æ‰€æœ‰ OpenClash ä¸ºæ˜¾ç¤ºåç§°
      # ============================================
      - name: ä¿®æ”¹ç™»å½•é¡µé¢æ‰€æœ‰ OpenClash ä¸ºæ˜¾ç¤ºåç§°
        run: |
          $loginPageFile = "lib/pages/login_page.dart"
          $displayName = "${{ github.event.inputs.display_name }}"
          $content = Get-Content $loginPageFile -Raw

          # å…¨å±€æ›¿æ¢æ‰€æœ‰ OpenClash ä¸ºæ˜¾ç¤ºåç§°
          $content = $content.Replace("OpenClash", $displayName)

          # å†™å›æ–‡ä»¶
          $content | Set-Content $loginPageFile -Force -Encoding UTF8

          Write-Host "å·²å°†ç™»å½•é¡µé¢æ‰€æœ‰ OpenClash æ›¿æ¢ä¸º '$displayName'"
        shell: pwsh

      # ============================================
      # æ­¥éª¤ 13: ä¿®å¤ä¸­æ–‡å®‰è£…ç›®å½•åç§°é—®é¢˜
      # ============================================
      - name: ä¿®å¤ä¸­æ–‡å®‰è£…ç›®å½•åç§°é—®é¢˜
        run: |
          $displayName = "${{ github.event.inputs.display_name }}"
          $app_id = "${{ github.event.inputs.app_id }}"
          
          # 1. ä¿®æ”¹MakeExeConfigç±»ï¼Œå¼ºåˆ¶ä½¿ç”¨è‹±æ–‡ç›®å½•å
          $makeExeConfigFile = "plugins/flutter_distributor/packages/flutter_app_packager/lib/src/makers/exe/make_exe_config.dart"
          if (Test-Path $makeExeConfigFile) {
            $content = Get-Content $makeExeConfigFile -Raw
            
            # ä¿®æ”¹defaultInstallDirNameæ–¹æ³•ï¼Œç¡®ä¿ä½¿ç”¨è‹±æ–‡ç›®å½•å
            $oldPattern = "String get defaultInstallDirName => '\{autopf64\}\\\\\\$appName';"
            $newPattern = "String get defaultInstallDirName => '{autopf64}\\\\' + appName.replaceAll(RegExp(r'[^a-zA-Z0-9_\\-]'), '_');"
            
            if ($content -match [regex]::Escape($oldPattern)) {
              $content = $content -replace [regex]::Escape($oldPattern), $newPattern
              Write-Host "å·²ä¿®æ”¹MakeExeConfigç±»ï¼Œé¿å…ä¸­æ–‡å®‰è£…ç›®å½•å" -ForegroundColor Green
            }
            
            # å†™å›æ–‡ä»¶
            $content | Set-Content $makeExeConfigFile -Force -Encoding UTF8
          } else {
            Write-Host "è­¦å‘Š: æ‰¾ä¸åˆ° MakeExeConfig æ–‡ä»¶ï¼Œè·³è¿‡ä¿®æ”¹" -ForegroundColor Yellow
          }
          
          # 2. ç¡®ä¿make_config.yamlä¸­æ˜ç¡®æŒ‡å®šè‹±æ–‡å®‰è£…ç›®å½•å
          $makeConfigFile = "windows/packaging/exe/make_config.yaml"
          if (Test-Path $makeConfigFile) {
            $content = Get-Content $makeConfigFile -Raw
            
            # æ·»åŠ æˆ–ä¿®æ”¹å®‰è£…ç›®å½•åç§°é…ç½®
            if ($content -match "install_dir_name:") {
              $content = $content -replace "install_dir_name: .*", "install_dir_name: `"{autopf64}\\$app_id`""
            } else {
              $content += "`ninstall_dir_name: `"{autopf64}\\$app_id`""
            }
            
            # å†™å›æ–‡ä»¶
            $content | Set-Content $makeConfigFile -Force
            
            Write-Host "å·²åœ¨make_config.yamlä¸­è®¾ç½®è‹±æ–‡å®‰è£…ç›®å½•å: `"{autopf64}\\$app_id`"" -ForegroundColor Green
          }
          
          Write-Host "ä¸­æ–‡å®‰è£…ç›®å½•åç§°é—®é¢˜ä¿®å¤å®Œæˆ" -ForegroundColor Green
        shell: pwsh

      # ============================================
      # æ­¥éª¤ 14: ä¿®æ”¹åº”ç”¨çª—å£æ ‡é¢˜å’Œæ‰˜ç›˜åç§°
      # ============================================
      - name: ä¿®æ”¹åº”ç”¨çª—å£æ ‡é¢˜å’Œæ‰˜ç›˜åç§°
        run: |
          $displayName = "${{ github.event.inputs.display_name }}"
          
          # 1. ä¿®æ”¹çª—å£æ ‡é¢˜æ ç»„ä»¶
          $windowManagerFile = "lib/manager/window_manager.dart"
          if (Test-Path $windowManagerFile) {
            $content = Get-Content $windowManagerFile -Raw
            $content = $content -replace 'Text\(\s*appName,', "Text(`"$displayName`","
            $content | Set-Content $windowManagerFile -Force -Encoding UTF8
            Write-Host "å·²ä¿®æ”¹çª—å£æ ‡é¢˜æ æ–‡æœ¬ä¸º: $displayName"
          }
          
          # 2. ä¿®æ”¹åŸç”Ÿçª—å£æ ‡é¢˜
          $mainCppFile = "windows/runner/main.cpp"
          if (Test-Path $mainCppFile) {
            # æ£€æµ‹æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦
            $containsChinese = $displayName -match '[\u4e00-\u9fff]'
            
            if ($containsChinese) {
              # è½¬æ¢ä¸­æ–‡åˆ°Unicodeè½¬ä¹‰åºåˆ—
              $unicodeTitle = ""
              foreach ($char in $displayName.ToCharArray()) {
                # å¦‚æœæ˜¯ASCIIå­—ç¬¦ï¼Œä¿æŒåŸæ ·
                if ([int][char]$char -lt 128) {
                  $unicodeTitle += $char
                } else {
                  # è½¬æ¢ä¸ºUnicodeè½¬ä¹‰åºåˆ—
                  $unicodeTitle += "\u" + ([int][char]$char).ToString("X4")
                }
              }
              # ä½¿ç”¨Unicodeè½¬ä¹‰åºåˆ—æ›¿æ¢çª—å£æ ‡é¢˜
              (Get-Content $mainCppFile) -replace 'if \(!window.Create\(L"FlClash", origin, size\)\)', "if (!window.Create(L`"$unicodeTitle`", origin, size))" | Set-Content $mainCppFile
              Write-Host "å·²ä¿®æ”¹WindowsåŸç”Ÿçª—å£æ ‡é¢˜ (ä½¿ç”¨Unicodeè½¬ä¹‰åºåˆ—)"
            } else {
              # ä¸åŒ…å«ä¸­æ–‡ï¼Œç›´æ¥ä½¿ç”¨åŸå­—ç¬¦ä¸²
              (Get-Content $mainCppFile) -replace 'if \(!window.Create\(L"FlClash", origin, size\)\)', "if (!window.Create(L`"$displayName`", origin, size))" | Set-Content $mainCppFile
              Write-Host "å·²ä¿®æ”¹WindowsåŸç”Ÿçª—å£æ ‡é¢˜"
            }
          }
          
          # 3. ä¿®æ”¹æ‰˜ç›˜æç¤ºæ–‡æœ¬
          $trayFile = "lib/common/tray.dart"
          if (Test-Path $trayFile) {
            $content = Get-Content $trayFile -Raw
            $content = $content -replace 'trayManager\.setToolTip\(\s*appName,', "trayManager.setToolTip(`"$displayName`","
            $content | Set-Content $trayFile -Force -Encoding UTF8
            Write-Host "å·²ä¿®æ”¹æ‰˜ç›˜æç¤ºæ–‡æœ¬ä¸º: $displayName"
          }
          
          # 4. ä¿®æ”¹åº”ç”¨æ ‡é¢˜
          $applicationFile = "lib/application.dart"
          if (Test-Path $applicationFile) {
            $content = Get-Content $applicationFile -Raw
            $content = $content -replace 'title: appName,', "title: `"$displayName`","
            $content | Set-Content $applicationFile -Force -Encoding UTF8
            Write-Host "å·²ä¿®æ”¹åº”ç”¨æ ‡é¢˜ä¸º: $displayName"
          }
        shell: pwsh

      # ============================================
      # æ­¥éª¤ 15: ä¿®æ”¹Runner.rcä¸­çš„äº§å“åç§°
      # ============================================
      - name: ä¿®æ”¹Runner.rcä¸­çš„äº§å“åç§°
        run: |
          $displayName = "${{ github.event.inputs.display_name }}"
          $app_id = "${{ github.event.inputs.app_id }}"
          
          # ä¿®æ”¹Runner.rcä¸­çš„äº§å“åç§° - å°†ProductNameè®¾ä¸ºè‹±æ–‡app_idï¼ŒFileDescriptionä¿æŒä¸­æ–‡displayName
          $rcFile = "windows/runner/Runner.rc"
          if (Test-Path $rcFile) {
            (Get-Content $rcFile) -replace 'VALUE "ProductName", ".*"', "VALUE `"ProductName`", `"$app_id`"" | Set-Content $rcFile
            (Get-Content $rcFile) -replace 'VALUE "FileDescription", ".*"', "VALUE `"FileDescription`", `"$displayName`"" | Set-Content $rcFile
            (Get-Content $rcFile) -replace 'VALUE "InternalName", ".*"', "VALUE `"InternalName`", `"$displayName`"" | Set-Content $rcFile
            (Get-Content $rcFile) -replace 'VALUE "ProductName", ".*"', "VALUE `"ProductName`", `"$app_id`"" | Set-Content $rcFile
            (Get-Content $rcFile) -replace 'VALUE "OriginalFilename", ".*"', "VALUE `"OriginalFilename`", `"$app_id.exe`"" | Set-Content $rcFile
            Write-Host "å·²ä¿®æ”¹ $rcFile ä¸­çš„äº§å“åç§°ä¸º $app_id (å†…éƒ¨æ ‡è¯†ç¬¦)ï¼Œæ–‡ä»¶æè¿°ä¸º $displayName (æ˜¾ç¤ºåç§°)"
          }
        shell: pwsh

      # ============================================
      # æ­¥éª¤ 16: æ›¿æ¢ inno_setup.iss ä¸­çš„è¿›ç¨‹å
      # ============================================
      - name: æ›¿æ¢ inno_setup.iss ä¸­çš„è¿›ç¨‹å
        run: |
          $app_id = "${{ github.event.inputs.app_id }}"
          $issFile = "windows/packaging/exe/inno_setup.iss"
          if (Test-Path $issFile) {
            $content = Get-Content $issFile -Raw
            
            # æ›¿æ¢ä¸»ç¨‹åºè¿›ç¨‹å - ä½¿ç”¨ regex::Escape æ–¹æ³•
            $content = $content -replace [regex]::Escape("FlClash.exe"), "${app_id}.exe"
            
            # æ›¿æ¢Coreè¿›ç¨‹å - ä½¿ç”¨ regex::Escape æ–¹æ³•
            $content = $content -replace [regex]::Escape("FlClashCore.exe"), "${app_id}Core.exe"
            
            # æ›¿æ¢HelperServiceè¿›ç¨‹å - ä½¿ç”¨ regex::Escape æ–¹æ³•
            $content = $content -replace [regex]::Escape("FlClashHelperService.exe"), "${app_id}HelperService.exe"
            
            # å†™å›æ–‡ä»¶
            $content | Set-Content $issFile -Force -Encoding UTF8
            Write-Host "å·²æ›¿æ¢ inno_setup.iss ä¸­çš„è¿›ç¨‹å: ${app_id}.exe, ${app_id}Core.exe, ${app_id}HelperService.exe"
          } else {
            Write-Host "è­¦å‘Š: æ‰¾ä¸åˆ° inno_setup.iss æ–‡ä»¶"
          }
        shell: pwsh       
        
      # ============================================
      # æ­¥éª¤ 17: ç¡®ä¿Windowså®‰è£…ç¨‹åºé…ç½®æ¡Œé¢å¿«æ·æ–¹å¼
      # ============================================
      - name: ç¡®ä¿Windowså®‰è£…ç¨‹åºé…ç½®æ¡Œé¢å¿«æ·æ–¹å¼
        run: |
          $displayName = "${{ github.event.inputs.display_name }}"
          $app_id = "${{ github.event.inputs.app_id }}"
          
          # ç¡®ä¿Windowså®‰è£…ç¨‹åºé…ç½®æ–‡ä»¶ä½¿ç”¨ä¸€è‡´çš„åç§°
          $makeConfigFile = "windows/packaging/exe/make_config.yaml"
          if (Test-Path $makeConfigFile) {
            $content = Get-Content $makeConfigFile -Raw
            
            # ä»…ä¿®æ”¹æ˜¾ç¤ºåç§°
            $content = $content -replace "display_name: .*", "display_name: $displayName"
            
            # å†æ¬¡ç¡®ä¿å®‰è£…ç›®å½•åç§°ä½¿ç”¨è‹±æ–‡app_id
            if ($content -match "install_dir_name:") {
              $content = $content -replace "install_dir_name: .*", "install_dir_name: `"{autopf64}\\$app_id`""
            } else {
              $content += "`ninstall_dir_name: `"{autopf64}\\$app_id`""
            }
            
            # ç¡®ä¿åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
            if ($content -notmatch "create_desktop_icon:") {
              $content += "`ncreate_desktop_icon: true`n"
            } else {
              $content = $content -replace "create_desktop_icon: false", "create_desktop_icon: true"
            }
            
            # å†™å›æ–‡ä»¶
            $content | Set-Content $makeConfigFile -Force
            
            Write-Host "å·²æ›´æ–°Windowså®‰è£…ç¨‹åºé…ç½®ï¼Œç¡®ä¿åˆ›å»ºæ¡Œé¢å›¾æ ‡å¹¶ä½¿ç”¨è‹±æ–‡å®‰è£…ç›®å½•å:"
            Get-Content $makeConfigFile
          }
        shell: pwsh
        
      # ============================================
      # æ­¥éª¤ 18: ä¿®æ”¹ setup.dart ä¸­çš„ appName
      # ============================================
      - name: ä¿®æ”¹ setup.dart ä¸­çš„ appName
        run: |
          $app_id = "${{ github.event.inputs.app_id }}"
          $setupFile = "setup.dart"
          
          # è¯»å–æ–‡ä»¶å†…å®¹
          $content = Get-Content $setupFile -Raw
          
          # ä¿®æ”¹ appName ä¸ºä¼ å…¥çš„ app_idï¼ˆå•å¼•å·ï¼‰
          $content = $content -replace "static String get appName => '[^']+';", "static String get appName => '$app_id';"
          
          # å†™å›æ–‡ä»¶
          $content | Set-Content $setupFile -Force -Encoding UTF8
          
          Write-Host "å·²ä¿®æ”¹ setup.dart ä¸­çš„ appName ä¸º: $app_id"
        shell: pwsh

      # ============================================
      # æ­¥éª¤ 19: è®¾ç½® Go ç¯å¢ƒ
      # ============================================
      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'
          cache-dependency-path: |
            core/go.sum
            
      # ============================================
      # æ­¥éª¤ 20: è®¾ç½® Flutter Master ç¯å¢ƒ (ARM64 å¿…éœ€)
      # ============================================
      - name: è®¾ç½® Flutter Master ç¯å¢ƒ (ARM64)
        uses: subosito/flutter-action@v2
        with:
          channel: master  # Windows ARM64 å¿…é¡»ä½¿ç”¨ master é€šé“
          cache: true

      # ============================================
      # æ­¥éª¤ 21: è·å– Flutter ä¾èµ–
      # ============================================
      - name: è·å– Flutter ä¾èµ–
        run: flutter pub get

      # ============================================
      # æ­¥éª¤ 22: æ‰§è¡Œæ„å»ºè„šæœ¬ (ARM64 æ¶æ„)
      # ============================================
      - name: æ‰§è¡Œæ„å»ºè„šæœ¬
        run: dart setup.dart windows --arch arm64 --env stable
      
      # ============================================
      # æ­¥éª¤ 23: æ£€æŸ¥æ„å»ºäº§ç‰©
      # ============================================
      - name: æ£€æŸ¥æ„å»ºäº§ç‰©
        run: |
          Write-Host "æ£€æŸ¥æ„å»ºäº§ç‰©..." -ForegroundColor Yellow
          
          # åˆ—å‡ºdistç›®å½•å†…å®¹
          if (Test-Path "dist") {
            Write-Host "distç›®å½•å†…å®¹:" -ForegroundColor Green
            Get-ChildItem -Path "dist" -Recurse | ForEach-Object {
              Write-Host "  $($_.FullName)" -ForegroundColor Cyan
            }
          } else {
            Write-Host "distç›®å½•ä¸å­˜åœ¨" -ForegroundColor Red
          }
          
          # åˆ—å‡ºbuildç›®å½•å†…å®¹
          if (Test-Path "build/windows/arm64/runner/Release") {
            Write-Host "build/windows/arm64/runner/Releaseç›®å½•å†…å®¹:" -ForegroundColor Green
            Get-ChildItem -Path "build/windows/arm64/runner/Release" -Recurse | ForEach-Object {
              Write-Host "  $($_.FullName)" -ForegroundColor Cyan
            }
          } else {
            Write-Host "build/windows/arm64/runner/Releaseç›®å½•ä¸å­˜åœ¨" -ForegroundColor Yellow
          }
          
          # æœç´¢æ‰€æœ‰exeæ–‡ä»¶
          Write-Host "æœç´¢æ‰€æœ‰exeæ–‡ä»¶:" -ForegroundColor Yellow
          Get-ChildItem -Path "." -Filter "*.exe" -Recurse | ForEach-Object {
            Write-Host "  æ‰¾åˆ°exeæ–‡ä»¶: $($_.FullName)" -ForegroundColor Green
          }
        shell: pwsh
      
      # ============================================
      # æ­¥éª¤ 24: ä¸Šä¼ æ„å»ºäº§ç‰©
      # ============================================
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.app_id }}-${{ github.event.inputs.version }}-windows-arm64
          path: dist/
          retention-days: 7
          
      # ============================================
      # æ­¥éª¤ 25: ç”Ÿæˆæ„å»ºæ€»ç»“
      # ============================================
      - name: ç”Ÿæˆæ„å»ºæ€»ç»“
        run: |
          echo "## ğŸ‰ Windows ARM64 æ„å»ºå®Œæˆ" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "### æ„å»ºä¿¡æ¯" >> $env:GITHUB_STEP_SUMMARY
          echo "- **åº”ç”¨åç§°**: ${{ github.event.inputs.display_name }}" >> $env:GITHUB_STEP_SUMMARY
          echo "- **åº”ç”¨ID**: ${{ github.event.inputs.app_id }}" >> $env:GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬å·**: ${{ github.event.inputs.version }}" >> $env:GITHUB_STEP_SUMMARY
          echo "- **æ¶æ„**: ARM64" >> $env:GITHUB_STEP_SUMMARY
          echo "- **ç§æœ‰ä»“åº“**: ${{ env.PRIVATE_REPO }}" >> $env:GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯/æ ‡ç­¾**: ${{ env.PRIVATE_REPO_REF }}" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "### æ„å»ºäº§ç‰©" >> $env:GITHUB_STEP_SUMMARY
          echo '```' >> $env:GITHUB_STEP_SUMMARY
          Get-ChildItem -Path dist/ >> $env:GITHUB_STEP_SUMMARY
          echo '```' >> $env:GITHUB_STEP_SUMMARY
        shell: pwsh

