name: Linux ARM64 æ„å»º (å…¬å¼€ä»“åº“ç‰ˆæœ¬)

# è¿™ä¸ªæ–‡ä»¶åº”è¯¥æ”¾åœ¨å…¬å¼€ä»“åº“ä¸­
# å®ƒä¼šæ‹‰å–ç§æœ‰ä»“åº“çš„ä»£ç è¿›è¡Œ ARM æ¶æ„æ„å»º

# ============================================
# é…ç½®ç§æœ‰ä»“åº“ä¿¡æ¯ï¼ˆåœ¨è¿™é‡Œä¿®æ”¹ï¼‰
# ============================================
env:
  PRIVATE_REPO: 'print520/NetAPP'  # ä¿®æ”¹ä¸ºä½ çš„ç§æœ‰ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)
  PRIVATE_REPO_REF: 'main'         # ä¿®æ”¹ä¸ºä½ è¦æ„å»ºçš„åˆ†æ”¯/æ ‡ç­¾/commit

on:
  workflow_dispatch:
    inputs:
      config_urls:
        description: 'é…ç½®URLåˆ—è¡¨ï¼ˆä»¥é€—å·åˆ†éš”ï¼‰'
        required: true
        default: ''
      update_url:
        description: 'æ›´æ–°æ£€æŸ¥URL'
        required: true
        default: ''
      app_id:
        description: 'åº”ç”¨ID(ä»…é™è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿)'
        required: true
        default: ''
      core_name:
        description: 'æ ¸å¿ƒåç§°(Coreç¨‹åºåç§°ï¼Œä»…é™è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿)'
        required: true
        default: ''
      display_name:
        description: 'æ˜¾ç¤ºåç§°(æ”¯æŒä¸­æ–‡)'
        required: true
        default: ''
      icon_url:
        description: 'åº”ç”¨å›¾æ ‡URL'
        required: true
        default: ''
      identifier:
        description: 'åº”ç”¨idè¯†åˆ«ç '
        required: true
        default: ''
      version:
        description: 'ç‰ˆæœ¬å·'
        required: true
        default: '2.0.1'
      test_url:
        description: 'æµ‹é€ŸURL'
        required: true
        default: 'http://cp.cloudflare.com/generate_204'

jobs:
  build-linux-arm64:
    # ä½¿ç”¨ ARM æ¶æ„çš„ runnerï¼ˆGitHub Actions çš„ ARM runnerï¼‰
    runs-on: ubuntu-24.04-arm
    
    steps:
      # ============================================
      # æ­¥éª¤ 1: æ£€å‡ºç§æœ‰ä»“åº“ä»£ç 
      # ============================================
      - name: æ£€å‡ºç§æœ‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PRIVATE_REPO }}
          ref: ${{ env.PRIVATE_REPO_REF }}
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          submodules: recursive
          
      # ============================================
      # æ­¥éª¤ 2: è·å–åº”ç”¨å›¾æ ‡
      # ============================================
      - name: è·å–åº”ç”¨å›¾æ ‡
        run: |
          mkdir -p temp_icons
          curl -L ${{ github.event.inputs.icon_url }} -o temp_icons/app_icon.png

      # ============================================
      # æ­¥éª¤ 3: ä¿®æ”¹é…ç½® URLs
      # ============================================
      - name: ä¿®æ”¹é…ç½®URLs
        run: |
          CONFIG_FILE="lib/common/config_service.dart"
          CONFIG_URLS="${{ github.event.inputs.config_urls }}"
          
          # åˆ†å‰²URLåˆ—è¡¨
          IFS=',' read -ra URL_ARRAY <<< "$CONFIG_URLS"
          
          # å»ºç«‹ä¸´æ—¶æ–‡ä»¶
          TEMP_FILE=$(mktemp)
          
          # å¤„ç†æ–‡ä»¶å†…å®¹ï¼Œè¡Œè¿›è¡Œå¤„ç†
          FOUND_START=0
          FOUND_END=0
          
          while IFS= read -r line; do
            # æ£€æµ‹é…ç½®æ•°ç»„å¼€å§‹è¡Œ
            if [[ $line =~ "static const List<String> _configUrls = [" ]]; then
              echo "$line" >> $TEMP_FILE
              FOUND_START=1
              
              # è¾“å‡ºURLåˆ—è¡¨
              for ((i=0; i<${#URL_ARRAY[@]}; i++)); do
                URL=$(echo "${URL_ARRAY[i]}" | xargs)  # å»é™¤ç©ºç™½å­—ç¬¦
                if [ $i -lt $((${#URL_ARRAY[@]}-1)) ]; then
                  echo "    '$URL'," >> $TEMP_FILE
                else
                  echo "    '$URL'" >> $TEMP_FILE
                fi
              done
              
              # è·³è¿‡åŸæ¥çš„URLå†…å®¹ï¼Œç›´åˆ°æ‰¾åˆ°ç»“æŸç¬¦
              while IFS= read -r skip_line; do
                if [[ $skip_line =~ "  ];" ]]; then
                  FOUND_END=1
                  echo "$skip_line" >> $TEMP_FILE
                  break
                fi
              done
              
              # å¦‚æœæ²¡æ‰¾åˆ°ç»“æŸç¬¦ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€è¡Œ
              if [ $FOUND_END -eq 0 ]; then
                continue
              fi
            elif [ $FOUND_START -eq 1 ] && [ $FOUND_END -eq 0 ]; then
              # è·³è¿‡åŸå§‹URLåˆ—è¡¨ä¸­çš„è¡Œ
              continue
            else
              # å¤åˆ¶å…¶ä»–è¡Œ
              echo "$line" >> $TEMP_FILE
            fi
          done < "$CONFIG_FILE"
          
          # å¦‚æœæ–‡ä»¶è¢«æˆåŠŸå¤„ç†ï¼Œåˆ™æ›¿æ¢åŸå§‹æ–‡ä»¶
          if [ $FOUND_START -eq 1 ] && [ $FOUND_END -eq 1 ]; then
            cat $TEMP_FILE > $CONFIG_FILE
            echo "å·²æˆåŠŸä¿®æ”¹é…ç½®URLs"
          else
            echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°é…ç½®URLæ•°ç»„ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼"
            cat $CONFIG_FILE | grep -A 10 "_configUrls"
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f $TEMP_FILE
          
          # æ£€æŸ¥ä¿®æ”¹ç»“æœ
          echo "ä¿®æ”¹åçš„é…ç½®:"
          grep -A 10 "_configUrls" $CONFIG_FILE

      # ============================================
      # æ­¥éª¤ 4: ä¿®æ”¹æ›´æ–°URL
      # ============================================
      - name: ä¿®æ”¹æ›´æ–°URL
        run: |
          API_FILE="lib/common/api_service.dart"
          UPDATE_URL="${{ github.event.inputs.update_url }}"
          
          # æ›¿æ¢æ›´æ–°URL
          if [ -f "$API_FILE" ]; then
            sed -i "s|final customUpdateUrl = \'[^\']*\';|final customUpdateUrl = '$UPDATE_URL';|" $API_FILE
            echo "å·²ä¿®æ”¹æ›´æ–°URL:"
            grep "customUpdateUrl" $API_FILE
          else
            echo "è­¦å‘Š: APIæ–‡ä»¶ $API_FILE ä¸å­˜åœ¨ï¼Œè·³è¿‡æ›´æ–°URLä¿®æ”¹"
          fi
      
      # ============================================
      # æ­¥éª¤ 5: æ›¿æ¢æµ‹é€ŸURL
      # ============================================
      - name: æ›¿æ¢æµ‹é€ŸURL defaultTestUrl
        run: |
          TEST_URL="${{ github.event.inputs.test_url }}"
          CONSTANT_FILE="lib/common/constant.dart"
          
          if [ -f "$CONSTANT_FILE" ]; then
            # è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ä»¥ä¾¿åœ¨sedä¸­ä½¿ç”¨
            ESCAPED_URL=$(echo "$TEST_URL" | sed 's/[&/\]/\\&/g')
            
            # æ›¿æ¢æµ‹é€ŸURL
            sed -i "s|const defaultTestUrl = \"[^\"]*\";|const defaultTestUrl = \"$ESCAPED_URL\";|" "$CONSTANT_FILE"
            
            echo "å·²ä¿®æ”¹æµ‹é€ŸURLä¸º: $TEST_URL"
            grep 'defaultTestUrl' "$CONSTANT_FILE"
          else
            echo "æœªæ‰¾åˆ° $CONSTANT_FILE"
          fi

      # ============================================
      # æ­¥éª¤ 6: ä¿®æ”¹ distribute_options.yaml ä¸­çš„åº”ç”¨åç§°
      # ============================================
      - name: ä¿®æ”¹ distribute_options.yaml ä¸­çš„åº”ç”¨åç§°
        run: |
          DISPLAY_NAME="${{ github.event.inputs.display_name }}"
          DISTRIBUTE_FILE="distribute_options.yaml"
          
          if [ -f "$DISTRIBUTE_FILE" ]; then
            # ä¿®æ”¹ app_name å±æ€§
            sed -i "s/app_name: 'FlClash'/app_name: '$DISPLAY_NAME'/" $DISTRIBUTE_FILE
            sed -i "s/app_name: \"FlClash\"/app_name: \"$DISPLAY_NAME\"/" $DISTRIBUTE_FILE
            
            echo "å·²ä¿®æ”¹ distribute_options.yaml ä¸­çš„åº”ç”¨åç§°ä¸º: $DISPLAY_NAME"
          else
            echo "è­¦å‘Š: æ‰¾ä¸åˆ° distribute_options.yaml æ–‡ä»¶"
          fi

      # ============================================
      # æ­¥éª¤ 7: ä¿®æ”¹LinuxåŒ…é…ç½® (ARM64 - æ”¯æŒä¸­æ–‡æ˜¾ç¤ºåç§°)
      # ============================================
      - name: ä¿®æ”¹LinuxåŒ…é…ç½®ï¼ˆæ”¯æŒä¸­æ–‡æ˜¾ç¤ºåç§°ï¼‰
        run: |
          DISPLAY_NAME="${{ github.event.inputs.display_name }}"
          APP_ID="${{ github.event.inputs.app_id }}"
          
          echo "=========================================="
          echo "  é…ç½®Linux ARM64è½¯ä»¶åŒ…"
          echo "=========================================="
          echo "å†…éƒ¨æ ‡è¯†ç¬¦(app_id): $APP_ID"
          echo "æ˜¾ç¤ºåç§°(æ”¯æŒä¸­æ–‡): $DISPLAY_NAME"
          echo "æ¶æ„: ARM64"
          echo ""
          
          # æ›´æ–°AppImageé…ç½®
          APPIMAGE_CONFIG="linux/packaging/appimage/make_config.yaml"
          if [ -f "$APPIMAGE_CONFIG" ]; then
            # ä½¿ç”¨YAMLå¤šè¡Œå­—ç¬¦ä¸²æ–¹å¼ç¡®ä¿ä¸­æ–‡æ­£ç¡®å¤„ç†
            sed -i "s/display_name: .*/display_name: $DISPLAY_NAME/" $APPIMAGE_CONFIG
            # æ›´æ–°generic_nameä¹Ÿä½¿ç”¨ä¸­æ–‡æ˜¾ç¤ºåç§°
            sed -i "s/generic_name: .*/generic_name: $DISPLAY_NAME/" $APPIMAGE_CONFIG
            # æ›´æ–°keywordsï¼Œæ·»åŠ ä¸­æ–‡åç§°
            sed -i "s/- FlClash/- $DISPLAY_NAME/" $APPIMAGE_CONFIG
            echo "âœ… å·²æ›´æ–°AppImageé…ç½®"
            echo "   æ˜¾ç¤ºåç§°: $DISPLAY_NAME"
          fi
          
          # æ›´æ–°DEBé…ç½®
          DEB_CONFIG="linux/packaging/deb/make_config.yaml"
          if [ -f "$DEB_CONFIG" ]; then
            # display_nameæ”¯æŒä¸­æ–‡ï¼ˆç”¨äº.desktopæ–‡ä»¶çš„Nameå­—æ®µï¼‰
            sed -i "s/display_name: .*/display_name: $DISPLAY_NAME/" $DEB_CONFIG
            # package_nameå¿…é¡»æ˜¯ASCIIï¼ˆè½¯ä»¶åŒ…æ ‡è¯†ç¬¦ï¼‰
            sed -i "s/package_name: .*/package_name: $APP_ID/" $DEB_CONFIG
            # æ›´æ–°generic_name
            sed -i "s/generic_name: .*/generic_name: $DISPLAY_NAME/" $DEB_CONFIG
            echo "âœ… å·²æ›´æ–°DEBåŒ…é…ç½®"
            echo "   åŒ…å(package_name): $APP_ID"
            echo "   æ˜¾ç¤ºåç§°(display_name): $DISPLAY_NAME"
          fi
          
          # æ›´æ–°RPMé…ç½®
          RPM_CONFIG="linux/packaging/rpm/make_config.yaml"
          if [ -f "$RPM_CONFIG" ]; then
            # RPMçš„display_nameä¹Ÿæ”¯æŒä¸­æ–‡
            sed -i "s/display_name: .*/display_name: $DISPLAY_NAME/" $RPM_CONFIG
            # æ›´æ–°generic_name
            sed -i "s/generic_name: .*/generic_name: $DISPLAY_NAME/" $RPM_CONFIG
            echo "âœ… å·²æ›´æ–°RPMåŒ…é…ç½®"
            echo "   æ˜¾ç¤ºåç§°: $DISPLAY_NAME"
          fi
          
          # æ›´æ–°CMakeLists.txtï¼ˆäºŒè¿›åˆ¶æ–‡ä»¶åå¿…é¡»æ˜¯ASCIIï¼‰
          CMAKE_FILE="linux/CMakeLists.txt"
          if [ -f "$CMAKE_FILE" ]; then
            # ä½¿ç”¨app_idä½œä¸ºäºŒè¿›åˆ¶æ–‡ä»¶å
            sed -i "s/set(BINARY_NAME \"FlClash\")/set(BINARY_NAME \"$APP_ID\")/" $CMAKE_FILE
            sed -i "s/project(FlClash LANGUAGES CXX)/project($APP_ID LANGUAGES CXX)/" $CMAKE_FILE
            echo "âœ… å·²æ›´æ–°CMakeLists.txt"
            echo "   é¡¹ç›®å: $APP_ID"
            echo "   äºŒè¿›åˆ¶å: $APP_ID"
          fi
          
          # ä¿®æ”¹ç‰ˆæœ¬å·
          BUILD_NUMBER=$(date +%Y%m%d%H)
          VERSION="${{ github.event.inputs.version }}"
          sed -i -E "s/version: [0-9]+\.[0-9]+\.[0-9]+(\+[0-9]+)?/version: $VERSION+$BUILD_NUMBER/" pubspec.yaml
          
          echo ""
          echo "âœ… ç‰ˆæœ¬å·å·²æ›´æ–°ä¸º: $VERSION+$BUILD_NUMBER"
          grep "version:" pubspec.yaml
          
          echo ""
          echo "=========================================="
          echo "  Linux ARM64è½¯ä»¶åŒ…é…ç½®å®Œæˆ"
          echo "  - è½¯ä»¶åŒ…å/äºŒè¿›åˆ¶å: $APP_ID (ASCII)"
          echo "  - ç”¨æˆ·çœ‹åˆ°çš„åç§°: $DISPLAY_NAME (æ”¯æŒä¸­æ–‡)"
          echo "=========================================="

      # ============================================
      # æ­¥éª¤ 8: æ›¿æ¢åº”ç”¨å›¾æ ‡
      # ============================================
      - name: æ›¿æ¢åº”ç”¨å›¾æ ‡
        run: |
          # å®‰è£…ImageMagick
          sudo apt-get update
          sudo apt-get install -y imagemagick
          
          # åˆ›å»ºåˆé€‚å¤§å°çš„å›¾æ ‡
          mkdir -p assets/images
          convert temp_icons/app_icon.png -resize 550x550 assets/images/icon.png
          
          # å¤åˆ¶åˆ°Linuxèµ„æºç›®å½•
          mkdir -p linux/assets
          convert temp_icons/app_icon.png -resize 256x256 linux/assets/icon.png
          
          # ä¸ºDEBå’ŒRPMåŒ…å‡†å¤‡å›¾æ ‡
          mkdir -p linux/packaging/deb/assets
          mkdir -p linux/packaging/rpm/assets
          mkdir -p linux/packaging/appimage/assets
          
          convert temp_icons/app_icon.png -resize 256x256 linux/packaging/deb/assets/icon.png
          convert temp_icons/app_icon.png -resize 256x256 linux/packaging/rpm/assets/icon.png
          convert temp_icons/app_icon.png -resize 256x256 linux/packaging/appimage/assets/icon.png
          
          echo "å·²æ›¿æ¢Linuxåº”ç”¨å›¾æ ‡"

      # ============================================
      # æ­¥éª¤ 9: ä¿®æ”¹ç™»å½•é¡µé¢åº”ç”¨åç§°
      # ============================================
      - name: ä¿®æ”¹ç™»å½•é¡µé¢åº”ç”¨åç§°
        run: |
          # è¯»å– login_page.dart æ–‡ä»¶
          LOGIN_PAGE_FILE="lib/pages/login_page.dart"
          DISPLAY_NAME="${{ github.event.inputs.display_name }}"
          
          # æ›¿æ¢æ–‡æœ¬ 'OpenClash' ä¸ºåŠ¨æ€çš„æ˜¾ç¤ºåç§°
          sed -i "s/'OpenClash'/'$DISPLAY_NAME'/" $LOGIN_PAGE_FILE
          sed -i "s/'Â© \${DateTime\.now()\.year} OpenClash\. ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚'/'Â© \${DateTime.now().year} $DISPLAY_NAME. ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚'/" $LOGIN_PAGE_FILE
          
          echo "å·²å°†ç™»å½•é¡µé¢çš„åº”ç”¨åç§°ä» OpenClash æ›´æ”¹ä¸º '$DISPLAY_NAME'"

      # ============================================
      # æ­¥éª¤ 10: è®¾ç½® Go ç¯å¢ƒ
      # ============================================
      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'
          cache-dependency-path: |
            core/go.sum

      # ============================================
      # æ­¥éª¤ 11: è®¾ç½® Flutter ç¯å¢ƒ (ARM64 ä½¿ç”¨ Master é€šé“)
      # ============================================
      - name: è®¾ç½® Flutter Master ç¯å¢ƒ (ARM64)
        uses: subosito/flutter-action@v2
        with:
          channel: master  # ARM64 å¿…é¡»ä½¿ç”¨ master é€šé“
          cache: true

      # ============================================
      # æ­¥éª¤ 12: ä¿®æ”¹å¸¸é‡å’Œæ ‡è¯†ç¬¦
      # ============================================
      - name: ä¿®æ”¹å¸¸é‡å’Œæ ‡è¯†ç¬¦
        run: |
          CORE_NAME="${{ github.event.inputs.core_name }}"
          DISPLAY_NAME="${{ github.event.inputs.display_name }}"
          CONSTANT_FILE="lib/common/constant.dart"
          
          # ä¿®æ”¹ constant.dart æ–‡ä»¶
          if [ -f "$CONSTANT_FILE" ]; then
            echo "ä¿®æ”¹ constant.dart ä¸­çš„åº”ç”¨æ ‡è¯†ç¬¦..."
            
            # å¤‡ä»½åŸå§‹æ–‡ä»¶
            cp "$CONSTANT_FILE" "${CONSTANT_FILE}.backup"
            
            # ä¿®æ”¹ appName å¸¸é‡ï¼ˆå•å¼•å·ï¼‰
            sed -i "s|const appName = '[^']*';|const appName = '$DISPLAY_NAME';|g" "$CONSTANT_FILE"
            
            # ä¿®æ”¹ Unix Socket è·¯å¾„ä¸­çš„ FlClashSocket_
            sed -i "s|FlClashSocket_|${CORE_NAME}Socket_|g" "$CONSTANT_FILE"
            
            # ä¿®æ”¹ Isolate åç§°
            sed -i "s|FlClashMainIsolate|${CORE_NAME}MainIsolate|g" "$CONSTANT_FILE"
            sed -i "s|FlClashServiceIsolate|${CORE_NAME}ServiceIsolate|g" "$CONSTANT_FILE"
            
            # æ˜¾ç¤ºä¿®æ”¹å‰çš„åŸå§‹å†…å®¹ï¼ˆç”¨äºè°ƒè¯•ï¼‰
            echo "ä¿®æ”¹å‰çš„å…³é”®å†…å®¹:"
            grep -E "(appName|Socket_|Isolate)" "$CONSTANT_FILE" || echo "æœªæ‰¾åˆ°ç›¸å…³å†…å®¹"
            
            echo "å·²ä¿®æ”¹ä»¥ä¸‹æ ‡è¯†ç¬¦:"
            echo "- appName: FlClash -> $DISPLAY_NAME"
            echo "- Unix Socket: FlClashSocket_ -> ${CORE_NAME}Socket_"
            echo "- Main Isolate: FlClashMainIsolate -> ${CORE_NAME}MainIsolate"
            echo "- Service Isolate: FlClashServiceIsolate -> ${CORE_NAME}ServiceIsolate"
            
            # éªŒè¯ä¿®æ”¹ - ä½¿ç”¨æ›´å®½æ¾çš„éªŒè¯æ¡ä»¶
            echo "éªŒè¯ä¿®æ”¹ç»“æœ..."
            
            # æ£€æŸ¥ appName ä¿®æ”¹
            if grep -q "const appName = '$DISPLAY_NAME'" "$CONSTANT_FILE"; then
              echo "âœ“ appName ä¿®æ”¹æˆåŠŸ"
            else
              echo "âœ— appName ä¿®æ”¹å¤±è´¥"
              echo "å½“å‰ appName å†…å®¹:"
              grep "const appName" "$CONSTANT_FILE" || echo "æœªæ‰¾åˆ° appName"
            fi
            
            # æ£€æŸ¥ Socket ä¿®æ”¹
            if grep -q "${CORE_NAME}Socket_" "$CONSTANT_FILE"; then
              echo "âœ“ Socket åç§°ä¿®æ”¹æˆåŠŸ"
            else
              echo "âœ— Socket åç§°ä¿®æ”¹å¤±è´¥"
              echo "å½“å‰ Socket å†…å®¹:"
              grep "Socket_" "$CONSTANT_FILE" || echo "æœªæ‰¾åˆ° Socket"
            fi
            
            # æ£€æŸ¥ Isolate ä¿®æ”¹
            if grep -q "${CORE_NAME}MainIsolate" "$CONSTANT_FILE"; then
              echo "âœ“ MainIsolate ä¿®æ”¹æˆåŠŸ"
            else
              echo "âœ— MainIsolate ä¿®æ”¹å¤±è´¥"
              echo "å½“å‰ Isolate å†…å®¹:"
              grep "Isolate" "$CONSTANT_FILE" || echo "æœªæ‰¾åˆ° Isolate"
            fi
            
            # æ£€æŸ¥ ServiceIsolate ä¿®æ”¹
            if grep -q "${CORE_NAME}ServiceIsolate" "$CONSTANT_FILE"; then
              echo "âœ“ ServiceIsolate ä¿®æ”¹æˆåŠŸ"
            else
              echo "âœ— ServiceIsolate ä¿®æ”¹å¤±è´¥"
            fi
            
            # æ˜¾ç¤ºä¿®æ”¹åçš„å…³é”®å†…å®¹
            echo "ä¿®æ”¹åçš„å…³é”®å†…å®¹:"
            grep -E "(appName|Socket_|Isolate)" "$CONSTANT_FILE" || echo "æœªæ‰¾åˆ°ç›¸å…³å†…å®¹"
            
            # å¦‚æœè‡³å°‘ appName ä¿®æ”¹æˆåŠŸï¼Œå°±è®¤ä¸ºæˆåŠŸ
            if grep -q "const appName = '$DISPLAY_NAME'" "$CONSTANT_FILE"; then
              echo "âœ“ constant.dart ä¸»è¦ä¿®æ”¹æˆåŠŸ"
              rm -f "${CONSTANT_FILE}.backup"
            else
              echo "âœ— constant.dart ä¿®æ”¹å¤±è´¥ï¼Œæ¢å¤åŸæ–‡ä»¶"
              mv "${CONSTANT_FILE}.backup" "$CONSTANT_FILE"
              exit 1
            fi
          else
            echo "è­¦å‘Š: æ‰¾ä¸åˆ° constant.dart æ–‡ä»¶"
          fi

      # ============================================
      # æ­¥éª¤ 13: ä¿®æ”¹ setup.dart ä¸­çš„åº”ç”¨åç§°
      # ============================================
      - name: ä¿®æ”¹ setup.dart ä¸­çš„åº”ç”¨åç§°
        run: |
          # è·å–è‡ªå®šä¹‰æ ¸å¿ƒåç§°ï¼Œæå–åº”ç”¨åç§°éƒ¨åˆ†ï¼ˆå»æ‰Coreåç¼€ï¼‰
          CORE_NAME="${{ github.event.inputs.core_name }}"
          # å¦‚æœç”¨æˆ·è¾“å…¥çš„æ˜¯å¸¦Coreçš„åç§°ï¼Œå»æ‰Coreåç¼€ï¼›å¦åˆ™ç›´æ¥ä½¿ç”¨
          if [[ "$CORE_NAME" == *"Core" ]]; then
            APP_NAME="${CORE_NAME%Core}"
          else
            APP_NAME="$CORE_NAME"
          fi
          
          SETUP_FILE="setup.dart"
          
          # åªæœ‰å½“åº”ç”¨åç§°ä¸æ˜¯é»˜è®¤å€¼æ—¶æ‰ä¿®æ”¹
          if [ "$APP_NAME" != "FlClash" ]; then
            echo "ä¿®æ”¹ setup.dart ä¸­çš„åº”ç”¨åç§°ä¸º: ${APP_NAME}"
            echo "è¿™å°†è‡ªåŠ¨ä½¿ coreName å˜ä¸º: ${APP_NAME}Core"
            
            # å¤‡ä»½åŸå§‹æ–‡ä»¶
            cp "$SETUP_FILE" "${SETUP_FILE}.backup"
            
            # ä¿®æ”¹ appName getterï¼Œè¿™æ · coreName ä¼šè‡ªåŠ¨å˜æˆ ${APP_NAME}Core
            sed -i "s/static String get appName => 'FlClash';/static String get appName => '${APP_NAME}';/" "$SETUP_FILE"
            
            # éªŒè¯ä¿®æ”¹æ˜¯å¦æˆåŠŸ
            if grep -q "static String get appName => '${APP_NAME}';" "$SETUP_FILE"; then
              echo "âœ“ setup.dart åº”ç”¨åç§°ä¿®æ”¹æˆåŠŸ"
              echo "ä¿®æ”¹åçš„ appName getter:"
              grep "static String get appName" "$SETUP_FILE"
              echo "coreName å°†è‡ªåŠ¨å˜ä¸º: ${APP_NAME}Core"
            else
              echo "âœ— setup.dart åº”ç”¨åç§°ä¿®æ”¹å¤±è´¥ï¼Œæ¢å¤åŸæ–‡ä»¶"
              echo "å½“å‰ appName getter å†…å®¹:"
              grep "static String get appName" "$SETUP_FILE" || echo "æœªæ‰¾åˆ° appName getter"
              mv "${SETUP_FILE}.backup" "$SETUP_FILE"
              exit 1
            fi
          else
            echo "ä½¿ç”¨é»˜è®¤åº”ç”¨åç§° FlClashï¼Œè·³è¿‡ setup.dart ä¿®æ”¹"
          fi

      # ============================================
      # æ­¥éª¤ 14: ä¿®æ”¹æ ¸å¿ƒè·¯å¾„å’Œé”æ–‡ä»¶å¼•ç”¨
      # ============================================
      - name: ä¿®æ”¹æ ¸å¿ƒè·¯å¾„å’Œé”æ–‡ä»¶å¼•ç”¨
        run: |
          # è·å–å‚æ•°ï¼ˆä¸setup.dartå’ŒCMakeLists.txtä¿æŒä¸€è‡´çš„é€»è¾‘ï¼‰
          CORE_NAME="${{ github.event.inputs.core_name }}"
          
          # å¦‚æœç”¨æˆ·è¾“å…¥çš„æ˜¯å¸¦Coreçš„åç§°ï¼Œå»æ‰Coreåç¼€ï¼›å¦åˆ™ç›´æ¥ä½¿ç”¨
          if [[ "$CORE_NAME" == *"Core" ]]; then
            APP_NAME="${CORE_NAME%Core}"
          else
            APP_NAME="$CORE_NAME"
          fi
          
          # è‡ªåŠ¨ç”Ÿæˆæ ¸å¿ƒåç§°ï¼ˆä¸setup.dartçš„coreNameé€»è¾‘ä¸€è‡´ï¼‰
          FINAL_CORE_NAME="${APP_NAME}Core"
          
          PATH_FILE="lib/common/path.dart"
          
          if [ -f "$PATH_FILE" ]; then
            # å¤‡ä»½åŸå§‹æ–‡ä»¶
            cp "$PATH_FILE" "${PATH_FILE}.backup"
            
            echo "ä¿®æ”¹æ ¸å¿ƒè·¯å¾„å¼•ç”¨å’Œé”æ–‡ä»¶åç§°..."
            echo "åº”ç”¨åç§°: ${APP_NAME}"
            echo "æ ¸å¿ƒåç§°: ${FINAL_CORE_NAME}"
            
            # æ˜¾ç¤ºä¿®æ”¹å‰çš„æ–‡ä»¶å†…å®¹
            echo "ä¿®æ”¹å‰çš„æ–‡ä»¶å†…å®¹:"
            grep -E "(FlClashCore|FlClash\.lock)" "$PATH_FILE" || echo "æœªæ‰¾åˆ°ç›¸å…³å†…å®¹"
            
            # ä¿®æ”¹æ ¸å¿ƒè·¯å¾„ - åŒ¹é…å®é™…çš„æ–‡ä»¶å†…å®¹ï¼ˆå•å¼•å·ï¼‰
            sed -i "s|'FlClashCore\$executableExtension'|'${FINAL_CORE_NAME}\$executableExtension'|g" "$PATH_FILE"
            # ä¿®æ”¹é”æ–‡ä»¶åç§° - åŒ¹é…å®é™…çš„æ–‡ä»¶å†…å®¹ï¼ˆå•å¼•å·ï¼‰
            sed -i "s|'FlClash\.lock'|'${APP_NAME}.lock'|g" "$PATH_FILE"
            
            echo "å·²æ›´æ–°æ ¸å¿ƒè·¯å¾„å¼•ç”¨ä¸º ${FINAL_CORE_NAME}"
            echo "å·²æ›´æ–°é”æ–‡ä»¶åç§°å¼•ç”¨ä¸º ${APP_NAME}.lock"
            
            # æ˜¾ç¤ºä¿®æ”¹åçš„æ–‡ä»¶å†…å®¹
            echo "ä¿®æ”¹åçš„æ–‡ä»¶å†…å®¹:"
            grep -E "(${FINAL_CORE_NAME}|${APP_NAME}\.lock)" "$PATH_FILE" || echo "æœªæ‰¾åˆ°ç›¸å…³å†…å®¹"
            
            # éªŒè¯ä¿®æ”¹ç»“æœ
            if grep -q "${FINAL_CORE_NAME}" "$PATH_FILE" && grep -q "${APP_NAME}\.lock" "$PATH_FILE"; then
              echo "âœ“ æ ¸å¿ƒè·¯å¾„å’Œé”æ–‡ä»¶åä¿®æ”¹æˆåŠŸ"
              rm -f "${PATH_FILE}.backup"
            else  
              echo "âœ— ä¿®æ”¹å¤±è´¥ï¼Œæ¢å¤å¤‡ä»½"
              mv "${PATH_FILE}.backup" "$PATH_FILE"
              exit 1
            fi
          else
            echo "è­¦å‘Š: æ‰¾ä¸åˆ° path.dart æ–‡ä»¶: $PATH_FILE"
          fi

      # ============================================
      # æ­¥éª¤ 15: ä¿®æ”¹åº”ç”¨çª—å£æ ‡é¢˜å’Œæ‰˜ç›˜åç§°ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
      # ============================================
      - name: ä¿®æ”¹åº”ç”¨çª—å£æ ‡é¢˜å’Œæ‰˜ç›˜åç§°ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
        run: |
          DISPLAY_NAME="${{ github.event.inputs.display_name }}"
          
          echo "æ›´æ–°ç•Œé¢æ˜¾ç¤ºæ–‡æœ¬ä¸ºä¸­æ–‡åç§°: $DISPLAY_NAME"
          
          # 1. ä¿®æ”¹çª—å£æ ‡é¢˜æ ç»„ä»¶
          WINDOW_MANAGER_FILE="lib/manager/window_manager.dart"
          if [ -f "$WINDOW_MANAGER_FILE" ]; then
            sed -i "s/const Text(appName)/const Text(\"$DISPLAY_NAME\")/" $WINDOW_MANAGER_FILE
            sed -i "s/Text(appName,/Text(\"$DISPLAY_NAME\",/" $WINDOW_MANAGER_FILE
            echo "âœ… å·²ä¿®æ”¹çª—å£æ ‡é¢˜æ æ–‡æœ¬ä¸º: $DISPLAY_NAME"
          fi
          
          # 2. ä¿®æ”¹åŸç”Ÿçª—å£æ ‡é¢˜ï¼ˆæ”¯æŒä¸­æ–‡UTF-8ï¼‰
          MAIN_CC_FILE="linux/my_application.cc"
          if [ -f "$MAIN_CC_FILE" ]; then
            # GTKæ”¯æŒUTF-8ç¼–ç çš„ä¸­æ–‡
            sed -i "s/gtk_window_set_title(window, \"FlClash\")/gtk_window_set_title(window, \"$DISPLAY_NAME\")/" $MAIN_CC_FILE
            sed -i "s/gtk_header_bar_set_title(header_bar, \"FlClash\")/gtk_header_bar_set_title(header_bar, \"$DISPLAY_NAME\")/" $MAIN_CC_FILE
            echo "âœ… å·²ä¿®æ”¹LinuxåŸç”Ÿçª—å£æ ‡é¢˜ï¼ˆæ”¯æŒä¸­æ–‡UTF-8ï¼‰"
            echo "   æ ‡é¢˜: $DISPLAY_NAME"
          fi
          
          # 3. ä¿®æ”¹æ‰˜ç›˜æç¤ºæ–‡æœ¬
          TRAY_FILE="lib/common/tray.dart"
          if [ -f "$TRAY_FILE" ]; then
            sed -i "s/trayManager\.setToolTip([[:space:]]*appName,/trayManager.setToolTip(\"$DISPLAY_NAME\",/" $TRAY_FILE
            echo "âœ… å·²ä¿®æ”¹æ‰˜ç›˜æç¤ºæ–‡æœ¬ä¸º: $DISPLAY_NAME"
          fi
          
          # 4. ä¿®æ”¹åº”ç”¨æ ‡é¢˜
          APPLICATION_FILE="lib/application.dart"
          if [ -f "$APPLICATION_FILE" ]; then
            sed -i "s/title: appName,/title: \"$DISPLAY_NAME\",/" $APPLICATION_FILE
            echo "âœ… å·²ä¿®æ”¹åº”ç”¨æ ‡é¢˜ä¸º: $DISPLAY_NAME"
          fi
          
          echo ""
          echo "=========================================="
          echo "  Linux ARM64ä¸­æ–‡æ˜¾ç¤ºåç§°é…ç½®å®Œæˆ"
          echo "  æ‰€æœ‰ç”¨æˆ·å¯è§çš„æ–‡æœ¬éƒ½å°†æ˜¾ç¤º: $DISPLAY_NAME"
          echo "=========================================="

      # ============================================
      # æ­¥éª¤ 16: ä¿®æ”¹CMakeLists.txtä¸­çš„æ ¸å¿ƒæ–‡ä»¶å
      # ============================================
      - name: ä¿®æ”¹CMakeLists.txtä¸­çš„æ ¸å¿ƒæ–‡ä»¶å
        run: |
          # è·å–åº”ç”¨åç§°ï¼ˆä¸setup.dartä¿®æ”¹ä¿æŒä¸€è‡´ï¼‰
          CORE_NAME="${{ github.event.inputs.core_name }}"
          # å¦‚æœç”¨æˆ·è¾“å…¥çš„æ˜¯å¸¦Coreçš„åç§°ï¼Œå»æ‰Coreåç¼€ï¼›å¦åˆ™ç›´æ¥ä½¿ç”¨
          if [[ "$CORE_NAME" == *"Core" ]]; then
            APP_NAME="${CORE_NAME%Core}"
          else
            APP_NAME="$CORE_NAME"
          fi
          
          # è‡ªåŠ¨ç”Ÿæˆæ ¸å¿ƒåç§°ï¼ˆä¸setup.dartçš„coreNameé€»è¾‘ä¸€è‡´ï¼‰
          FINAL_CORE_NAME="${APP_NAME}Core"
          
          CMAKE_FILE="linux/CMakeLists.txt"
          
          if [ -f "$CMAKE_FILE" ]; then
            # å¤‡ä»½åŸå§‹æ–‡ä»¶
            cp "$CMAKE_FILE" "${CMAKE_FILE}.backup"
            
            echo "ä¿®æ”¹CMakeLists.txtä¸­çš„æ ¸å¿ƒæ–‡ä»¶åä¸º: ${FINAL_CORE_NAME}"
            echo "åŸºäºåº”ç”¨åç§°: ${APP_NAME} è‡ªåŠ¨æ·»åŠ Coreåç¼€"
            
            # ä¿®æ”¹CMakeLists.txtä¸­çš„FlClashCoreä¸ºè‡ªå®šä¹‰æ ¸å¿ƒåç§°
            sed -i "s|FlClashCore|${FINAL_CORE_NAME}|g" "$CMAKE_FILE"
            
            echo "å·²æ›´æ–°CMakeLists.txtä¸­çš„æ ¸å¿ƒæ–‡ä»¶åå¼•ç”¨ä¸º ${FINAL_CORE_NAME}"
            
            # éªŒè¯ä¿®æ”¹ç»“æœ
            if grep -q "${FINAL_CORE_NAME}" "$CMAKE_FILE"; then
              echo "âœ“ CMakeLists.txt æ ¸å¿ƒæ–‡ä»¶åä¿®æ”¹æˆåŠŸ"
              rm -f "${CMAKE_FILE}.backup"
            else
              echo "âœ— CMakeLists.txt æ ¸å¿ƒæ–‡ä»¶åä¿®æ”¹å¤±è´¥ï¼Œæ¢å¤å¤‡ä»½"
              mv "${CMAKE_FILE}.backup" "$CMAKE_FILE"
              exit 1
            fi
          else
            echo "è­¦å‘Š: æ‰¾ä¸åˆ° CMakeLists.txt æ–‡ä»¶: $CMAKE_FILE"
          fi

      # ============================================
      # æ­¥éª¤ 17: ğŸ” éªŒè¯Linuxä¸­æ–‡é…ç½®
      # ============================================
      - name: ğŸ” éªŒè¯Linux ARM64ä¸­æ–‡é…ç½®
        run: |
          echo "=========================================="
          echo "  éªŒè¯Linux ARM64ä¸­æ–‡æ˜¾ç¤ºåç§°é…ç½®"
          echo "=========================================="
          
          DISPLAY_NAME="${{ github.event.inputs.display_name }}"
          APP_ID="${{ github.event.inputs.app_id }}"
          ALL_PASSED=true
          
          # æ£€æŸ¥å…³é”®é…ç½®æ–‡ä»¶
          echo "æ£€æŸ¥é…ç½®æ–‡ä»¶..."
          
          # 1. æ£€æŸ¥DEBé…ç½®
          if [ -f "linux/packaging/deb/make_config.yaml" ]; then
            if grep -q "display_name: $DISPLAY_NAME" "linux/packaging/deb/make_config.yaml"; then
              echo "âœ… DEB display_name é…ç½®æ­£ç¡®"
            else
              echo "âŒ DEB display_name é…ç½®é”™è¯¯"
              ALL_PASSED=false
            fi
            if grep -q "package_name: $APP_ID" "linux/packaging/deb/make_config.yaml"; then
              echo "âœ… DEB package_name é…ç½®æ­£ç¡®"
            else
              echo "âŒ DEB package_name é…ç½®é”™è¯¯"
              ALL_PASSED=false
            fi
          fi
          
          # 2. æ£€æŸ¥åŸç”Ÿçª—å£æ ‡é¢˜
          if [ -f "linux/my_application.cc" ]; then
            if grep -q "\"$DISPLAY_NAME\"" "linux/my_application.cc"; then
              echo "âœ… GTKçª—å£æ ‡é¢˜é…ç½®æ­£ç¡®ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰"
            else
              echo "âŒ GTKçª—å£æ ‡é¢˜é…ç½®é”™è¯¯"
              echo "   å½“å‰å†…å®¹:"
              grep "gtk_window_set_title\|gtk_header_bar_set_title" "linux/my_application.cc"
              ALL_PASSED=false
            fi
          fi
          
          # 3. æ£€æŸ¥CMakeLists.txt
          if [ -f "linux/CMakeLists.txt" ]; then
            if grep -q "BINARY_NAME \"$APP_ID\"" "linux/CMakeLists.txt"; then
              echo "âœ… äºŒè¿›åˆ¶æ–‡ä»¶åé…ç½®æ­£ç¡®"
            else
              echo "âŒ äºŒè¿›åˆ¶æ–‡ä»¶åé…ç½®é”™è¯¯"
              ALL_PASSED=false
            fi
          fi
          
          echo ""
          echo "å…³é”®é…ç½®é¢„è§ˆ:"
          echo "  APP_ID: $APP_ID"
          echo "  DISPLAY_NAME: $DISPLAY_NAME"
          echo "  æ¶æ„: ARM64"
          
          if [ "$ALL_PASSED" = true ]; then
            echo ""
            echo "âœ…âœ…âœ… Linux ARM64ä¸­æ–‡é…ç½®éªŒè¯é€šè¿‡ï¼"
            echo "ç”¨æˆ·å°†çœ‹åˆ°: $DISPLAY_NAME"
            echo "åŒ…åå’Œæ–‡ä»¶å: $APP_ID"
            echo "=========================================="
          else
            echo ""
            echo "âŒâŒâŒ Linux ARM64é…ç½®éªŒè¯å¤±è´¥ï¼"
            echo "=========================================="
            exit 1
          fi

      # ============================================
      # æ­¥éª¤ 18: è·å– Flutter ä¾èµ–
      # ============================================
      - name: è·å– Flutter ä¾èµ–
        run: flutter pub get

      # ============================================
      # æ­¥éª¤ 19: æ„å»º Linux ARM64 åº”ç”¨
      # ============================================
      - name: æ„å»º Linux ARM64 åº”ç”¨
        run: |
          echo "å¼€å§‹æ„å»º Linux ARM64 æ¶æ„..."
          dart setup.dart linux --arch arm64 --env stable
          echo "æ„å»ºå®Œæˆï¼"

      # ============================================
      # æ­¥éª¤ 20: æ˜¾ç¤ºæ„å»ºäº§ç‰©
      # ============================================
      - name: æ˜¾ç¤ºæ„å»ºäº§ç‰©
        run: |
          echo "æ„å»ºäº§ç‰©åˆ—è¡¨:"
          ls -lh dist/
          
          echo ""
          echo "ARM64 æ¶æ„æ ‡è¯†:"
          file dist/* || true

      # ============================================
      # æ­¥éª¤ 21: ä¸Šä¼ æ„å»ºäº§ç‰©
      # ============================================
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.app_id }}-${{ github.event.inputs.version }}-linux-arm64
          path: dist/
          retention-days: 7
          
      # ============================================
      # æ­¥éª¤ 22: ç”Ÿæˆæ„å»ºæ€»ç»“
      # ============================================
      - name: ç”Ÿæˆæ„å»ºæ€»ç»“
        run: |
          echo "## ğŸ‰ Linux ARM64 æ„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æ˜¾ç¤ºåç§°**: ${{ github.event.inputs.display_name }} âœ… (æ”¯æŒä¸­æ–‡)" >> $GITHUB_STEP_SUMMARY
          echo "- **åº”ç”¨ID**: ${{ github.event.inputs.app_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬å·**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ¶æ„**: ARM64 (aarch64)" >> $GITHUB_STEP_SUMMARY
          echo "- **ç§æœ‰ä»“åº“**: ${{ env.PRIVATE_REPO }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯/æ ‡ç­¾**: ${{ env.PRIVATE_REPO_REF }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ä¸­æ–‡æ”¯æŒ" >> $GITHUB_STEP_SUMMARY
          echo "âœ… åº”ç”¨å¯åŠ¨å™¨æ˜¾ç¤º: ${{ github.event.inputs.display_name }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… çª—å£æ ‡é¢˜æ˜¾ç¤º: ${{ github.event.inputs.display_name }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ç³»ç»Ÿæ‰˜ç›˜æ˜¾ç¤º: ${{ github.event.inputs.display_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh dist/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

